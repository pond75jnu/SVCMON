{% extends 'base.html' %}

{% block title %}대시보드 - 전남대학교 웹사이트 모니터링 시스템{% endblock %}

{% block content %}
<!-- 상단 통계 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-globe text-2xl text-blue-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            총 엔드포인트
                        </dt>
                        <dd class="text-lg font-medium text-gray-900">
                            {{ total_endpoints }}개
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-users text-2xl text-green-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            활성 사용자
                        </dt>
                        <dd class="text-lg font-medium text-gray-900">
                            {{ total_users }}명
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_admin %}
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-user-clock text-2xl text-yellow-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            승인 대기
                        </dt>
                        <dd class="text-lg font-medium text-gray-900">
                            {{ pending_users }}명
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock text-2xl text-gray-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            최종 업데이트
                        </dt>
                        <dd class="text-sm font-medium text-gray-900" id="last-update">
                            방금 전
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 망구분 상태 그리드 -->
<div class="mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">망구분별 모니터링 상태</h2>
        <button onclick="refreshDashboard()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            <i class="fas fa-sync-alt mr-2"></i>새로고침
        </button>
    </div>
    
    {% if network_status %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for item in network_status %}
        <div class="network-card bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer"
             data-url="{% url 'dashboard:network_detail' item.network_group.id %}" onclick="navigateToNetwork(this)">
            <div class="p-6">
                <!-- 상태 표시 -->
                <div class="flex items-center justify-between mb-4">
                    <div class="status-indicator w-4 h-4 rounded-full 
                        {% if item.status == 'RED' %}bg-red-500{% elif item.status == 'AMBER' %}bg-yellow-500{% else %}bg-green-500{% endif %}">
                    </div>
                    <div class="text-sm text-gray-500">
                        {{ item.total_endpoints }}개 사이트
                    </div>
                </div>
                
                <!-- 망구분명 -->
                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                    {{ item.network_group.name }}
                </h3>
                
                <!-- 상세 상태 -->
                <div class="space-y-2">
                    {% if item.red_count > 0 %}
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-red-500 rounded-full mr-2"></div>
                        <span class="text-red-700">장애 {{ item.red_count }}개</span>
                    </div>
                    {% endif %}
                    
                    {% if item.amber_count > 0 %}
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></div>
                        <span class="text-yellow-700">신호없음 {{ item.amber_count }}개</span>
                    </div>
                    {% endif %}
                    
                    {% if item.green_count > 0 %}
                    <div class="flex items-center text-sm">
                        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                        <span class="text-green-700">정상 {{ item.green_count }}개</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- 상태 설명 -->
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <p class="text-xs text-gray-500">
                        {% if item.status == 'RED' %}
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            서비스 장애 발생
                        {% elif item.status == 'AMBER' %}
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            응답 신호 없음
                        {% else %}
                            <i class="fas fa-check-circle mr-1"></i>
                            모든 서비스 정상
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-gray-400 text-6xl mb-4">
            <i class="fas fa-network-wired"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">등록된 망구분이 없습니다</h3>
        <p class="text-gray-500 mb-6">모니터링을 시작하려면 먼저 망구분을 등록하세요.</p>
        {% if user.is_admin %}
        <a href="{% url 'monitoring:network_group_create' %}" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>망구분 등록
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 범례 -->
<div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">상태 범례</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="flex items-center">
            <div class="w-4 h-4 bg-green-500 rounded-full mr-3"></div>
            <div>
                <div class="font-medium text-green-700">정상 (GREEN)</div>
                <div class="text-sm text-gray-600">모든 서비스가 정상 응답</div>
            </div>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-yellow-500 rounded-full mr-3"></div>
            <div>
                <div class="font-medium text-yellow-700">신호없음 (AMBER)</div>
                <div class="text-sm text-gray-600">응답 없음 또는 지연</div>
            </div>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-red-500 rounded-full mr-3"></div>
            <div>
                <div class="font-medium text-red-700">장애 (RED)</div>
                <div class="text-sm text-gray-600">HTTP 오류 또는 연결 실패</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function navigateToNetwork(element) {
        const url = element.getAttribute('data-url');
        location.href = url;
    }

    function refreshDashboard() {
        location.reload();
    }
    
    // 자동 새로고침 (5분마다)
    setInterval(function() {
        fetch('{% url "dashboard:dashboard_api" %}')
            .then(response => response.json())
            .then(data => {
                // 상태 업데이트 로직
                document.getElementById('last-update').textContent = '방금 전';
            })
            .catch(error => {
                console.error('Dashboard update failed:', error);
            });
    }, 300000); // 5분
    
    // 시간 업데이트
    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('ko-KR');
        document.getElementById('last-update').textContent = timeStr;
    }
    
    setInterval(updateTime, 1000);
</script>
{% endblock %}
