{% extends 'base.html' %}

{% block title %}대시보드 - 전남대학교 웹사이트 모니터링 시스템{% endblock %}

{% block content %}
<!-- 상단 통계 -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-globe text-2xl text-blue-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            총 엔드포인트
                        </dt>
                        <dd class="text-lg font-medium text-gray-900">
                            {{ total_endpoints }}개
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-users text-2xl text-green-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            활성 사용자
                        </dt>
                        <dd class="text-lg font-medium text-gray-900">
                            {{ total_users }}명
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_admin %}
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-user-clock text-2xl text-yellow-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            승인 대기
                        </dt>
                        <dd class="text-lg font-medium text-gray-900">
                            {{ pending_users }}명
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock text-2xl text-gray-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">
                            최종 업데이트
                        </dt>
                        <dd class="text-sm font-medium text-gray-900" id="last-update">
                            방금 전
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 망구분 상태 그리드 -->
<div class="mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900">망구분별 모니터링 상태</h2>
        <button onclick="refreshDashboard()" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            <i class="fas fa-sync-alt mr-2"></i>새로고침
        </button>
    </div>
    
    {% if network_status %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for item in network_status %}
        <div class="network-card bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer"
             data-network-id="{{ item.network_group.id }}"
             data-url="{% url 'dashboard:network_detail' item.network_group.id %}" onclick="navigateToNetwork(this)">
            <div class="p-6">
                <!-- 상태 표시 -->
                <div class="flex items-center justify-between mb-4">
                    <div class="status-icon w-6 h-6 rounded-full 
                        {% if item.status == 'RED' %}bg-red-500{% elif item.status == 'AMBER' %}bg-yellow-500{% else %}bg-green-500{% endif %}">
                    </div>
                    <div class="text-sm text-gray-500 endpoint-count">
                        {{ item.total_endpoints }}개 URL
                    </div>
                </div>
                
                <!-- 망구분명 -->
                <h3 class="text-lg font-semibold text-gray-900 mb-2">
                    {{ item.network_group.name }}
                </h3>
                
                <!-- 상태 텍스트 -->
                <div class="mb-2">
                    <span class="status-text text-sm font-medium
                        {% if item.status == 'RED' %}text-red-700{% elif item.status == 'AMBER' %}text-yellow-700{% else %}text-green-700{% endif %}">
                        {% if item.status == 'RED' %}장애{% elif item.status == 'AMBER' %}신호없음{% else %}정상{% endif %}
                    </span>
                </div>
                
                <!-- 상세 상태 -->
                <div class="status-detail text-xs text-gray-600">
                    {% if item.total_endpoints == 0 %}
                        등록된 엔드포인트 없음
                    {% else %}
                        정상:{{ item.green_count }} 신호없음:{{ item.amber_count }} 장애:{{ item.red_count }}
                    {% endif %}
                </div>
                
                <!-- 상태 설명 -->
                <div class="mt-4 pt-3 border-t border-gray-200">
                    <p class="text-xs text-gray-500 status-description">
                        {% if item.total_endpoints == 0 %}
                            <i class="fas fa-info-circle mr-1"></i>
                            등록된 엔드포인트 없음
                        {% elif item.status == 'RED' %}
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            서비스 장애 발생
                        {% elif item.status == 'AMBER' %}
                            <i class="fas fa-exclamation-circle mr-1"></i>
                            응답 신호 없음
                        {% else %}
                            <i class="fas fa-check-circle mr-1"></i>
                            모든 서비스 정상
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-gray-400 text-6xl mb-4">
            <i class="fas fa-network-wired"></i>
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">등록된 망구분이 없습니다</h3>
        <p class="text-gray-500 mb-6">모니터링을 시작하려면 먼저 망구분을 등록하세요.</p>
        {% if user.is_admin %}
        <a href="{% url 'monitoring:network_group_create' %}" 
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
            <i class="fas fa-plus mr-2"></i>망구분 등록
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- 범례 -->
<div class="bg-white rounded-lg shadow p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">상태 범례</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="flex items-center">
            <div class="w-4 h-4 bg-green-500 rounded-full mr-3"></div>
            <div>
                <div class="font-medium text-green-700">정상 (GREEN)</div>
                <div class="text-sm text-gray-600">모든 서비스가 정상 응답</div>
            </div>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-yellow-500 rounded-full mr-3"></div>
            <div>
                <div class="font-medium text-yellow-700">신호없음 (AMBER)</div>
                <div class="text-sm text-gray-600">응답 없음 또는 지연</div>
            </div>
        </div>
        <div class="flex items-center">
            <div class="w-4 h-4 bg-red-500 rounded-full mr-3"></div>
            <div>
                <div class="font-medium text-red-700">장애 (RED)</div>
                <div class="text-sm text-gray-600">HTTP 오류 또는 연결 실패</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let lastUpdateTime = new Date();
    
    function navigateToNetwork(element) {
        const url = element.getAttribute('data-url');
        location.href = url;
    }

    function refreshDashboard() {
        updateNetworkStatus();
    }
    
    function getStatusColor(status) {
        switch(status) {
            case 'GREEN': return 'bg-green-500';
            case 'AMBER': return 'bg-yellow-500';
            case 'RED': return 'bg-red-500';
            default: return 'bg-gray-500';
        }
    }
    
    function getStatusText(status) {
        switch(status) {
            case 'GREEN': return '정상';
            case 'AMBER': return '신호없음';
            case 'RED': return '장애';
            default: return '알 수 없음';
        }
    }
    
    function updateNetworkStatus() {
        fetch('{% url "dashboard:all_networks_status_api" %}')
            .then(response => response.json())
            .then(data => {
                data.network_status.forEach(network => {
                    const card = document.querySelector(`[data-network-id="${network.network_group_id}"]`);
                    if (card) {
                        // 상태 아이콘 업데이트
                        const statusIcon = card.querySelector('.status-icon');
                        if (statusIcon) {
                            statusIcon.className = `w-6 h-6 rounded-full status-icon ${getStatusColor(network.status)}`;
                        }
                        
                        // 상태 텍스트 업데이트
                        const statusText = card.querySelector('.status-text');
                        if (statusText) {
                            statusText.textContent = getStatusText(network.status);
                        }
                        
                        // URL 수 업데이트
                        const endpointCount = card.querySelector('.endpoint-count');
                        if (endpointCount) {
                            endpointCount.textContent = `${network.total_endpoints}개 URL`;
                        }
                        
                        // 상세 상태 업데이트
                        const statusDetail = card.querySelector('.status-detail');
                        if (statusDetail) {
                            statusDetail.textContent = `정상:${network.green_count} 신호없음:${network.amber_count} 장애:${network.red_count}`;
                        }
                        
                        // 상태 설명 업데이트 (하단 메시지)
                        const statusDescription = card.querySelector('.status-description');
                        if (statusDescription) {
                            let descriptionHTML = '';
                            if (network.total_endpoints === 0) {
                                descriptionHTML = '<i class="fas fa-info-circle mr-1"></i>등록된 엔드포인트 없음';
                            } else if (network.status === 'RED') {
                                descriptionHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>서비스 장애 발생';
                            } else if (network.status === 'AMBER') {
                                descriptionHTML = '<i class="fas fa-exclamation-circle mr-1"></i>응답 신호 없음';
                            } else {
                                descriptionHTML = '<i class="fas fa-check-circle mr-1"></i>모든 서비스 정상';
                            }
                            statusDescription.innerHTML = descriptionHTML;
                        }
                    }
                });
                
                lastUpdateTime = new Date(data.last_updated);
                updateLastUpdateTime();
            })
            .catch(error => {
                console.error('Dashboard update failed:', error);
            });
    }
    
    // 자동 새로고침 (10초마다)
    setInterval(updateNetworkStatus, 10000);
    
    // 시간 업데이트
    function updateLastUpdateTime() {
        const now = new Date();
        const diff = Math.floor((now - lastUpdateTime) / 1000);
        
        let timeText;
        if (diff < 60) {
            timeText = '방금 전';
        } else if (diff < 3600) {
            timeText = `${Math.floor(diff / 60)}분 전`;
        } else {
            timeText = lastUpdateTime.toLocaleTimeString('ko-KR');
        }
        
        document.getElementById('last-update').textContent = timeText;
    }
    
    setInterval(updateLastUpdateTime, 1000);
    
    // 페이지 로드 시 초기 업데이트
    document.addEventListener('DOMContentLoaded', function() {
        // 5초 후 첫 번째 자동 업데이트
        setTimeout(updateNetworkStatus, 5000);
    });
</script>
{% endblock %}
